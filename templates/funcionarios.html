{% extends 'base.html' %}
{% include 'header.html' %}
{% block title %}IMPACTO{% endblock %}

{% block body %}
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <div class=" bg-light p-4 mb-2">
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                <div class="flashes">
                    {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
                <script>
                    setTimeout(function () {
                        window.location.reload(1);
                    }, 2000);
                </script>
                {% endif %}
                {% endwith %}

                <div class="d-flex justify-content-between">
                    <h2>
                        Gerenciar <b>Funcionários</b>
                    </h2>
                    <button type="button" class="btn btn-success" data-toggle="modal" data-target="#modalAddFuncionario">Adicionar Funcionário</button>
                </div>

                <!-- Adicione a barra de pesquisa aqui -->
                <div class="mt-3 input-group mb-3">
                    <input type="text" class="form-control" placeholder="Pesquisar" id="searchField">
                    <button class="btn btn-primary" type="button" id="searchButton">
                        <i class="fa fa-search me-2"></i> Pesquisar
                    </button>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover table-dark">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Ativo</th>
                                <th>Ramal</th>
                                <th>Login</th>
                                <th>Senha</th>
                                <th>Nível de Permissão</th>
                                <th>Setor</th>
                                <th>Ação</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in funcionarios %}
                            <tr>
                                <td>{{ item.id }}</td>
                                <td>{{ item.nome }}</td>
                                <td>{{ item.ativo }}</td>
                                <td>{{ item.ramal }}</td>
                                <td>{{ item.login }}</td>
                                <td>{{ item.senha }}</td>
                                <td>{{ item.nivel_permissao }}</td>
                                <td>{{ item.setor.setor_nome }}</td>
                                <td>
                                    <a href="#" class="btn btn-warning btn-xs" data-toggle="modal" data-target="#modalEdit"
                                        data-id="{{ item.id }}" data-nome="{{ item.nome }}" data-ativo="{{ item.ativo }}"
                                        data-ramal="{{ item.ramal }}" data-login="{{ item.login }}"
                                        data-senha="{{ item.senha }}" data-nivel_permissao="{{ item.nivel_permissao }}"
                                        data-setor_id="{{ item.setor_id }}">Editar</a>
                                    <a href="/delete/{{ item.id }}" class="btn btn-danger btn-xs"
                                        onclick="return confirm('Tem certeza que deseja apagar?')">Apagar</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <a href="{{ url_for('gerar_pdf') }}" class="btn btn-primary" target="_blank">Gerar Relatório em PDF</a>
                </div>

                <!-- Pagination -->
                <nav aria-label="Page navigation example">
                    <ul class="pagination justify-content-center">
                        {% for page_num in pages %}
                        {% if page_num == current_page %}
                        <li class="page-item active">
                            <a class="page-link" href="#">{{ page_num }}</a>
                        </li>
                        {% else %}
                        <li class="page-item">
                            <a class="page-link" href="/page/{{ page_num }}">{{ page_num }}</a>
                        </li>
                        {% endif %}
                        {% endfor %}
                    </ul>
                </nav>
                <!-- End of Pagination -->
            </div>

            <div id="modalEdit" class="modal fade" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title">Atualizar informações</h4>
                        </div>
                        <div class="modal-body">
                            <form id="editForm" action="/update" method="post">
                                <div class="form-group">
                                    <label>Nome:</label>
                                    <input type="hidden" id="editId" name="id" value="">
                                    <input type="text" class="form-control" id="editNome" name="nome" required>
                                </div>
                                <div class="form-group">
                                    <label>Ativo:</label>
                                    <input type="text" class="form-control" id="editAtivo" name="ativo" required>
                                </div>
                                <div class="form-group">
                                    <label>Ramal:</label>
                                    <input type="number" class="form-control" id="editRamal" name="ramal" required>
                                </div>
                                <div class="form-group">
                                    <label>Login:</label>
                                    <input type="text" class="form-control" id="editLogin" name="login" required>
                                </div>
                                <div class="form-group">
                                    <label>Senha:</label>
                                    <input type="password" class="form-control" id="editSenha" name="senha" required>
                                </div>
                                <div class="form-group">
                                    <label>Nível de Permissão:</label>
                                    <input type="text" class="form-control" id="editNivel_permissao" name="nivel_permissao" required>
                                </div>
                                <div class="form-group">
                                    <label>Setor ID:</label>
                                    <input type="number" class="form-control" id="editSetor_id" name="setor_id" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Atualizar</button>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="modalAddFuncionario" class="modal fade" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title">Adicionar Funcionário</h4>
                        </div>
                        <div class="modal-body">
                            <form id="addForm" action="/insert" method="post">
                                <div class="form-group">
                                    <label>Nome:</label>
                                    <input type="text" class="form-control" id="addNome" name="nome" required>
                                </div>
                                <div class="form-group">
                                    <label>Ativo:</label>
                                    <input type="text" class="form-control" id="addAtivo" name="ativo" required>
                                </div>
                                <div class="form-group">
                                    <label>Ramal:</label>
                                    <input type="number" class="form-control" id="addRamal" name="ramal" required>
                                </div>
                                <div class="form-group">
                                    <label>Login:</label>
                                    <input type="text" class="form-control" id="addLogin" name="login" required>
                                </div>
                                <div class="form-group">
                                    <label>Senha:</label>
                                    <input type="password" class="form-control" id="addSenha" name="senha" required>
                                </div>
                                <div class="form-group">
                                    <label>Nível de Permissão:</label>
                                    <input type="text" class="form-control" id="addNivel_permissao" name="nivel_permissao" required>
                                </div>
                                <div class="form-group">
                                    <label>Setor ID:</label>
                                    <input type="number" class="form-control" id="addSetor_id" name="setor_id" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Adicionar</button>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    $('#modalEdit').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var id = button.data('id');
        var nome = button.data('nome');
        var ativo = button.data('ativo');
        var ramal = button.data('ramal');
        var login = button.data('login');
        var senha = button.data('senha');
        var nivel_permissao = button.data('nivel_permissao');
        var setor_id = button.data('setor_id');

        console.log(id, nome, ativo, ramal, login, senha, nivel_permissao, setor_id);  // Logging data to the console

        $('#editId').val(id);
        $('#editNome').val(nome);
        $('#editAtivo').val(ativo);
        $('#editRamal').val(ramal);
        $('#editLogin').val(login);
        $('#editSenha').val(senha);
        $('#editNivel_permissao').val(nivel_permissao);
        $('#editSetor_id').val(setor_id);
    });

    $(document).ready(function () {
        $('#searchButton').click(function () {
            var searchTerm = $('#searchField').val();
            if (searchTerm) {
                window.location.href = '/search?term=' + encodeURIComponent(searchTerm);
            }
        });
    });

    // Função para gerar o PDF ao clicar no botão "Gerar Relatório em PDF"
    $('#gerarPdfButton').click(function () {
        window.open('{{ url_for("gerar_pdf") }}', '_blank');
    });
</script>

{% endblock %}
